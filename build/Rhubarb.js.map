{"version":3,"file":"Rhubarb.js","sources":["../js/util/ReusableBufferCache.js","../js/util/CharByteMap.js","../js/core/Protocol.js","../js/handler/ProtocolParser.js","../js/util/Globals.js","../js/worker/WorkerBridge.js","../js/node/Server.js","../js/index.js"],"sourcesContent":["var ReusableBufferCache = function(){\n  this.cache = new Object();\n}\n\nReusableBufferCache.prototype.destroy = function(){\n  this.cache = new Object();\n}\n\nReusableBufferCache.prototype.notify = function(len){\n  if (!this.cache[len]){\n    var float32 = new Float32Array(len);\n    var uint8 = new Uint8Array(float32.buffer);\n    this.cache[len] = {\n      uint8: uint8,\n      float32: float32\n    };\n  }\n}\n\nReusableBufferCache.prototype.get = function(strLength){\n  var elem = this.cache[strLength];\n  if (!elem){\n    throw new Error(\"ReusableBufferCache is empty.\");\n  }\n  return elem;\n}\n\nexport default new ReusableBufferCache();\n","var supportedChars = [\n  \"!\", \"\\\"\", \"#\", \"$\", \"%\", \"&\", \"\\'\", \"(\", \")\", \"*\", \"+\", \",\", \"-\", \".\", \"/\",\n  \"0\", \"1\", \"2\", \"3\", \"4\", \"5\", \"6\", \"7\", \"8\", \"9\", \":\", \";\", \"<\", \"=\", \">\", \"?\",\n  \"@\", \"A\", \"B\", \"C\", \"D\", \"E\", \"F\", \"G\", \"H\", \"I\", \"J\", \"K\", \"L\", \"M\", \"N\", \"O\",\n  \"P\", \"R\", \"S\", \"T\", \"U\", \"V\", \"W\", \"X\", \"Y\", \"Z\", \"[\", \"\\\\\", \"]\", \"^\", \"_\", \"`\",\n  \"a\", \"b\", \"c\", \"d\", \"e\", \"f\", \"g\", \"h\", \"i\", \"j\", \"k\", \"l\", \"m\", \"n\", \"o\", \"p\",\n  \"r\", \"s\", \"t\", \"u\", \"v\", \"w\", \"x\", \"y\", \"z\", \"{\", \"|\", \"}\", \"~\", \"q\", \"Q\"\n];\n\nvar charByteMap = new Object();\nvar byteCharMap = new Object();\nfor (var i = 0; i<supportedChars.length; i++){\n  charByteMap[supportedChars[i]] = (i+1);\n  byteCharMap[(i+1)] = supportedChars[i];\n}\n\nexport {charByteMap, byteCharMap};\n","import ReusableBufferCache from \"../util/ReusableBufferCache\";\nimport {charByteMap, byteCharMap} from \"../util/CharByteMap\";\n\n\nvar Protocol = function(name, id){\n  this.name = name;\n  this.id = id;\n  this.parameters = new Object();\n  this.parameterIDsByParameterName = new Object();\n  this.parameterBufferIndicesByParameterName = new Object();\n  this.parameterValues = new Object();\n  this.boundGetter = this.getter.bind(this);\n}\n\nProtocol.prototype.MAX_STRING_PARAMETER_LENGTH = 100;\n\nProtocol.prototype.typeNumerical = {isNumerical: true, requiredBufferLen: 2};\n\nProtocol.prototype.getter = function(parameterName){\n  return this.parameterValues[parameterName];\n}\n\nProtocol.prototype.onValuesReceived = function(clientID){\n  if (this.onReceived){\n    this.onReceived(this.boundGetter, clientID);\n  }\n}\n\nProtocol.prototype.onOwnershipReceived = function(transferableMessageBody){\n  this.transferableMessageBody = transferableMessageBody;\n  this.transferableList[0] = transferableMessageBody.buffer;\n  this.hasOwnership = true;\n}\n\nProtocol.prototype.getCharByte = function(char){\n  return charByteMap[char] || 0;\n}\n\nProtocol.prototype.getParameterFromBuffer = function(parameterName){\n  var parameter = this.parameters[parameterName];\n  if (!parameter){\n    throw new Error(\"No such parameter: \"+parameterName+\" in protocol: \"+this.name);\n  }\n  var startIndex = this.parameterBufferIndicesByParameterName[parameterName];\n  if (parameter.isNumerical){\n    var value =  this.buffer[startIndex + 1];\n    this.parameterValues[parameterName] = value;\n    return value;\n  }\n  var computationBuffers = ReusableBufferCache.get(parameter.requiredBufferLen);\n  var float32 = computationBuffers.float32;\n  for (var i = 0; i<parameter.requiredBufferLen; i++){\n    float32[i] = this.buffer[startIndex + 1 + i];\n  }\n  var uint8 = computationBuffers.uint8;\n  var value = \"\";\n  for (var i = 0; i<uint8.length; i++){\n    if (uint8[i] == 0){\n      break;\n    }\n    value += byteCharMap[uint8[i]];\n  }\n  this.parameterValues[parameterName] = value;\n  return value;\n}\n\nProtocol.prototype.setParameterToBuffer = function(parameterName, value){\n  var parameter = this.parameters[parameterName];\n  if (!parameter){\n    throw new Error(\"No such parameter: \"+parameterName+\" in protocol: \"+this.name);\n  }\n  var startIndex = this.parameterBufferIndicesByParameterName[parameterName];\n  var parameterID = this.parameterIDsByParameterName[parameterName];\n  this.buffer[startIndex] = parameterID;\n  if (parameter.isNumerical){\n    this.buffer[startIndex + 1] = value;\n  }else{\n    if (value.length > parameter.maxLength){\n      throw new Error(\"Parameter overflow: \"+parameterName+\" in protocol \"+this.name);\n    }\n    var computationBuffers = ReusableBufferCache.get(parameter.requiredBufferLen);\n    var uint8 = computationBuffers.uint8;\n    for (var i = 0; i<uint8.length; i++){\n      if (i < value.length){\n        uint8[i] = this.getCharByte(value[i]);\n      }else{\n        uint8[i] = 0;\n      }\n    }\n    var float32 = computationBuffers.float32;\n    var curIndex = startIndex + 1;\n    for (var i = 0; i<float32.length; i++){\n      this.buffer[curIndex ++] = float32[i];\n    }\n  }\n  this.parameterValues[parameterName] = value;\n}\n\nProtocol.prototype.addNumericalParameter = function(parameterName){\n  this.parameters[parameterName] = this.typeNumerical;\n}\n\nProtocol.prototype.addStringParameter = function(parameterName, maxLength){\n  if (maxLength > this.MAX_STRING_PARAMETER_LENGTH){\n    throw new Error(\"Parameter size exceeds max allowed string parameter size \"+this.MAX_STRING_PARAMETER_LENGTH);\n  }\n  this.parameters[parameterName] = {\n    isNumerical: false, maxLength: maxLength, requiredBufferLen: (Math.ceil(maxLength / 4) + 1)\n  };\n}\n\nProtocol.prototype.init = function(){\n  var requiredBufferLen = 0;\n  var curParameterID = 0;\n  for (var parameterName in this.parameters){\n    this.parameterIDsByParameterName[parameterName] = curParameterID ++;\n    this.parameterBufferIndicesByParameterName[parameterName] = requiredBufferLen + 1;\n    var parameter = this.parameters[parameterName];\n    requiredBufferLen += parameter.requiredBufferLen;\n    if (!parameter.isNumerical){\n      ReusableBufferCache.notify(requiredBufferLen);\n    }\n  }\n  this.buffer = new Float32Array(requiredBufferLen + 1);\n  this.buffer[0] = this.id;\n  this.transferableMessageBody = new Float32Array(requiredBufferLen + 1);\n  this.transferableList = [this.transferableMessageBody.buffer];\n  this.hasOwnership = true;\n}\n\nexport default Protocol;\n","import Protocol from \"../core/Protocol\";\n\nvar ProtocolParser = function(){\n  this.NUMERICAL_TYPE = \"numerical\";\n  this.CHARACTER_TYPE = \"char\";\n  this.currentProtocolID = 1;\n}\n\nProtocolParser.prototype.destroy = function(){\n  this.currentProtocolID = 1;\n}\n\nProtocolParser.prototype.parseCharacterType = function(characterType){\n  var splitted = characterType.split(\"_\");\n  if (splitted[0] == this.CHARACTER_TYPE){\n    if (!splitted[1]){\n      return false;\n    }\n    return parseInt(splitted[1]);\n  }\n  return false;\n}\nProtocolParser.prototype.parseProtocol = function(protocolInfo, protocolName, protocolID){\n  var protocol = new Protocol(protocolName, protocolID);\n  for (var parameterName in protocolInfo){\n    var parameterType = protocolInfo[parameterName];\n    if (parameterType == this.NUMERICAL_TYPE){\n      protocol.addNumericalParameter(parameterName);\n    }else if (parameterType.startsWith(this.CHARACTER_TYPE)){\n      var maxLength = this.parseCharacterType(parameterType);\n      if (!maxLength){\n        throw new Error(\"Char types must be in format char_N, where N is the char length.\")\n      }\n      protocol.addStringParameter(parameterName, maxLength);\n    }else{\n      throw new Error(\"Invalid parameter type.\");\n    }\n  }\n  protocol.init();\n  return protocol;\n}\n\nProtocolParser.prototype.parse = function(jsonData){\n  var parsedProtocols = new Object();\n  for (var protocolName in jsonData){\n    var protocolInfo = jsonData[protocolName];\n    var protocol = this.parseProtocol(protocolInfo, protocolName, this.currentProtocolID ++);\n    parsedProtocols[protocol.name] = protocol;\n  }\n  return parsedProtocols;\n}\n\nexport default new ProtocolParser();\n","var Globals = function(){\n  this.isReady = false;\n}\n\nGlobals.prototype.destroy = function(){\n  this.protocolsByProtocolName = new Object();\n  this.protocolsByProtocolID = new Object();\n  this.isReady = false;\n  this.server = null;\n}\n\n\nGlobals.prototype.setReady = function(){\n  this.isReady = true;\n  if (this.onReady){\n    this.onReady();\n  }\n}\n\nGlobals.prototype.set = function(protocols){\n  this.protocolsByProtocolName = new Object();\n  this.protocolsByProtocolID = new Object();\n\n  for (var protocolName in protocols){\n    var protocol = protocols[protocolName];\n    this.protocolsByProtocolName[protocolName] = protocol;\n    this.protocolsByProtocolID[protocol.id] = protocol;\n  }\n}\n\nGlobals.prototype.setServer = function(server){\n  this.server = server;\n}\n\nexport default new Globals();\n","import Globals from \"../util/Globals\";\n\nvar WorkerBridge = function(){\n  this.isWorkerInitialized = false;\n  this.reusableArray = [];\n}\n\nWorkerBridge.prototype.destroy = function(){\n  this.isWorkerInitialized = false;\n  this.reusableArray = [];\n  this.worker.terminate();\n}\n\nWorkerBridge.prototype.onLatencyUpdated = function(latency){\n  if (this.latencyCallback){\n    this.latencyCallback(latency);\n  }\n}\n\nWorkerBridge.prototype.sendProtocol = function(protocol){\n  if (!protocol.hasOwnership){\n    console.error(\"Protocol does not have transferable ownership.\");\n    return;\n  }\n  for (var i = 0; i<protocol.buffer.length; i++){\n    protocol.transferableMessageBody[i] = protocol.buffer[i];\n  }\n  this.worker.postMessage(protocol.transferableMessageBody, protocol.transferableList);\n  protocol.hasOwnership = false;\n}\n\nWorkerBridge.prototype.initialize = function(workerPath, serverURL){\n  this.worker = new Worker(workerPath);\n\n  this.worker.onmessage = function(event){\n    var data = event.data;\n\n    if (data.isError){\n      this.onError(\"Cannot connect to the server.\");\n      return;\n    }\n\n    if (data.isConnected || data.isDisconnected){\n      if (data.isConnected){\n        this.isWorkerInitialized = true;\n        Globals.setReady();\n      }else{\n        if (this.onDisconnectedFromServer){\n          this.onDisconnectedFromServer();\n        }\n      }\n    }else{\n      if (data[0] == -2){\n        var latency = data[1];\n        this.reusableArray[0] = data.buffer;\n        this.worker.postMessage(data, this.reusableArray);\n        this.onLatencyUpdated(latency);\n        return;\n      }else{\n        var protocol = Globals.protocolsByProtocolID[data[0]];\n        protocol.buffer = data;\n        protocol.onOwnershipReceived(data);\n        for (var parameterName in protocol.parameters){\n          protocol.getParameterFromBuffer(parameterName);\n        }\n        protocol.onValuesReceived();\n        return;\n      }\n    }\n  }.bind(this);\n\n  this.worker.postMessage({\n    serverURL: serverURL\n  });\n}\n\nexport default new WorkerBridge();\n","import Globals from \"../util/Globals\";\n\nvar Server = function(wsLib){\n  this.wsLib = wsLib;\n  this.wsByClientID = new Object();\n  this.clientIDByWS = new Map();\n}\n\nServer.prototype.destroy = function(){\n  for (var clientID in this.wsByClientID){\n    var ws = this.wsByClientID[clientID];\n    ws.terminate();\n  }\n  this.wsServer.close();\n\n  this.wsByClientID = new Object();\n  this.clientIDByWS = new Map();\n\n  delete this.wsServer;\n}\n\nServer.prototype.sendProtocolToClient = function(clientID, protocol){\n  var clientWS = this.wsByClientID[clientID];\n  if (!clientWS){\n    throw new Error(\"No such client: \" + clientID);\n  }\n  clientWS.send(protocol.buffer);\n}\n\nServer.prototype.init = function(port){\n  this.wsServer = new this.wsLib.Server({ port: port });\n  Globals.setReady();\n  this.wsServer.on(\"connection\", function(ws){\n\n    var clientID = uuidv4();\n    this.wsByClientID[clientID] = ws;\n    this.clientIDByWS.set(ws, clientID);\n    if (this.onClientConnected){\n      this.onClientConnected(clientID);\n    }\n\n    ws.on(\"message\", function(data){\n      var protocolID = data.readFloatLE(0);\n      if (protocolID == 0){\n        ws.send(data);\n      }else{\n        var protocol = Globals.protocolsByProtocolID[protocolID];\n        var bufIndex = 4;\n        for (var i = 1; i<protocol.buffer.length; i++){\n          protocol.buffer[i] = data.readFloatLE(bufIndex);\n          bufIndex += 4;\n        }\n        for (var paramName in protocol.parameters){\n          protocol.getParameterFromBuffer(paramName);\n        }\n        protocol.onValuesReceived(this.clientID);\n      }\n    }.bind({clientID: clientID}));\n\n    ws.on(\"close\", function(){\n      var clientID = this.clientID;\n      var server = this.server;\n\n      delete server.wsByClientID[clientID];\n      server.clientIDByWS.delete(this.ws);\n\n      if (this.server.onClientDisconnected){\n        this.server.onClientDisconnected(this.clientID);\n      }\n    }.bind({clientID: clientID, server: this, ws: ws}));\n  }.bind(this));\n}\n\nfunction uuidv4(){\n  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {\n    var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);\n    return v.toString(16);\n  });\n}\n\nexport default Server;\n","import ProtocolParser from \"./handler/ProtocolParser\";\nimport WorkerBridge from \"./worker/WorkerBridge\";\nimport Server from \"./node/Server\";\nimport Globals from \"./util/Globals\";\nimport ReusableBufferCache from \"./util/ReusableBufferCache\";\n\nvar Rhubarb = function(){\n  this.IS_NODE = (typeof window == \"undefined\");\n}\n\n// PUBLIC APIs *****************************************************************\n\nRhubarb.prototype.init = function(parameters){\n  if (Globals.isReady){\n    throw new Error(\"Rhubarb already initialized. Use destroy API first.\");\n  }\n\n  this._validateParameters(parameters);\n\n  Globals.onReady = parameters.onReady;\n\n  if (this.IS_NODE){\n    this._initNode(parameters);\n    return;\n  }\n\n  var protocolDefinitionPath = parameters.protocolDefinitionPath;\n  var workerPath = parameters.workerPath;\n  var serverAddress = parameters.serverAddress;\n  var onError = parameters.onError;\n\n  var xhttpRequest = new XMLHttpRequest();\n  xhttpRequest.overrideMimeType(\"application/json\");\n  xhttpRequest.open(\"GET\", protocolDefinitionPath, true);\n  xhttpRequest.onreadystatechange = function(){\n    if (xhttpRequest.readyState == 4 && xhttpRequest.status == \"200\"){\n      var parsedJSON;\n      try{\n        parsedJSON = JSON.parse(xhttpRequest.responseText);\n      }catch(err){\n        onError(\"Protocol definition file is not a valid JSON: \" + err);\n        return;\n      }\n      var protocols = ProtocolParser.parse(parsedJSON);\n      Globals.set(protocols);\n      WorkerBridge.onError = onError;\n      this.initWorker(workerPath, serverAddress);\n    }else if (xhttpRequest.readyState == 4){\n      onError(\"Protocol definition file not found.\");\n      return;\n    }\n  }.bind({initWorker: this._initWorker});\n  xhttpRequest.send(null);\n}\n\nRhubarb.prototype.send = function(protocolName, valuesByParameterName, clientID){\n  if (!Globals.isReady){\n    throw new Error(\"Rhubarb is not initialized yet.\");\n  }\n  var protocol = Globals.protocolsByProtocolName[protocolName];\n  if (!protocol){\n    throw new Error(\"No such protocol: \" + protocolName);\n  }\n  for (var parameterName in protocol.parameters){\n    var value = valuesByParameterName[parameterName];\n    if (value == undefined || value == null) {\n      throw new Error(\"Parameter value not defined: \" + parameterName);\n    }\n    protocol.setParameterToBuffer(parameterName, valuesByParameterName[parameterName]);\n  }\n  if (!this.IS_NODE){\n    WorkerBridge.sendProtocol(protocol);\n  }else{\n    Globals.server.sendProtocolToClient(clientID, protocol);\n  }\n}\n\nRhubarb.prototype.onReceived = function(protocolName, callback){\n  if (!Globals.isReady){\n    throw new Error(\"Rhubarb is not initialized yet.\");\n  }\n  var protocol = Globals.protocolsByProtocolName[protocolName];\n  if (!protocol){\n    throw new Error(\"No such protocol: \" + protocolName);\n  }\n  if (!callback){\n    throw new Error(\"Callback not defined.\");\n  }\n  if (!callback instanceof Function){\n    throw new Error(\"Callback is not a function.\")\n  }\n  protocol.onReceived = callback;\n}\n\nRhubarb.prototype.onDisconnectedFromServer = function(callback){\n  if (!Globals.isReady){\n    throw new Error(\"Rhubarb is not initialized yet.\");\n  }\n  if (this.IS_NODE){\n    throw new Error(\"This Rhubarb instance is a server.\");\n  }\n  if (!callback){\n    throw new Error(\"Callback not defined.\");\n  }\n  if (!callback instanceof Function){\n    throw new Error(\"Callback is not a function.\")\n  }\n  WorkerBridge.onDisconnectedFromServer = callback;\n}\n\nRhubarb.prototype.onClientConnected = function(callback){\n  if (!Globals.isReady){\n    throw new Error(\"Rhubarb is not initialized yet.\");\n  }\n  if (!this.IS_NODE){\n    throw new Error(\"This Rhubarb instance is not a server.\");\n  }\n  if (!callback){\n    throw new Error(\"Callback not defined.\");\n  }\n  if (!callback instanceof Function){\n    throw new Error(\"Callback is not a function.\")\n  }\n  Globals.server.onClientConnected = callback;\n}\n\nRhubarb.prototype.onClientDisconnected = function(callback){\n  if (!Globals.isReady){\n    throw new Error(\"Rhubarb is not initialized yet.\");\n  }\n  if (!this.IS_NODE){\n    throw new Error(\"This Rhubarb instance is not a server.\");\n  }\n  if (!callback){\n    throw new Error(\"Callback not defined.\");\n  }\n  if (!callback instanceof Function){\n    throw new Error(\"Callback is not a function.\")\n  }\n  Globals.server.onClientDisconnected = callback;\n}\n\nRhubarb.prototype.onLatencyUpdated = function(callback){\n  if (!Globals.isReady){\n    throw new Error(\"Rhubarb is not initialized yet.\");\n  }\n  if (this.IS_NODE){\n    throw new Error(\"This Rhubarb instance is a server.\");\n  }\n  if (!callback){\n    throw new Error(\"Callback not defined.\");\n  }\n  if (!callback instanceof Function){\n    throw new Error(\"Callback is not a function.\")\n  }\n  WorkerBridge.latencyCallback = callback;\n}\n\nRhubarb.prototype.destroy = function(){\n  if (!Globals.isReady){\n    throw new Error(\"Rhubarb not initialized. Use init API first.\");\n  }\n\n  if (!this.IS_NODE){\n    WorkerBridge.destroy();\n  }else{\n    Globals.server.destroy();\n  }\n\n  Globals.destroy();\n  ReusableBufferCache.destroy();\n  ProtocolParser.destroy();\n}\n\n// END OF PUBLIC APIs **********************************************************\n\nRhubarb.prototype._validateParameters = function(parameters){\n  var protocolDefinitionPath = parameters.protocolDefinitionPath;\n  var workerPath = parameters.workerPath;\n  var isServer = parameters.isServer;\n  var serverAddress = parameters.serverAddress;\n  var serverListenPort = parameters.serverListenPort;\n  var onReady = parameters.onReady;\n  var onError = parameters.onError;\n\n  if (!protocolDefinitionPath){\n    throw new Error(\"protocolDefinitionPath is not defined within parameters.\");\n  }\n  if (!this.IS_NODE && !workerPath){\n    throw new Error(\"workerPath is not defined within parameters.\");\n  }\n  if (!this.IS_NODE && isServer){\n    throw new Error(\"Cannot use browser as a server.\");\n  }\n  if (isServer && !serverListenPort){\n    throw new Error(\"serverListenPort is not defined within parameters.\");\n  }\n  if (!isServer && !serverAddress){\n    throw new Error(\"serverAddress is not defined within parameters.\");\n  }\n  if (!this.IS_NODE){\n    if (!onReady){\n      throw new Error(\"onReady is not defined within parameters.\");\n    }\n    if (!onReady instanceof Function){\n      throw new Error(\"onReady parameter is not a Function.\");\n    }\n    if (!onError){\n      throw new Error(\"onError is not defined within parameters.\");\n    }\n    if (!onError instanceof Function){\n      throw new Error(\"onError parameter is not a Function.\");\n    }\n  }\n}\n\nRhubarb.prototype._initWorker = function(workerPath, serverAddress){\n  if (!this.IS_NODE && typeof Worker == \"undefined\"){\n    throw new Error(\"This browser does not support web workers.\");\n  }else if (!this.IS_NODE){\n    WorkerBridge.initialize(workerPath, serverAddress);\n  }\n}\n\nRhubarb.prototype._initNode = function(parameters){\n  var protocolDefinitionPath = parameters.protocolDefinitionPath;\n  var isServer = parameters.isServer;\n  var serverListenPort = parameters.serverListenPort;\n  var fs = require(\"fs\");\n\n  if (!fs.existsSync(protocolDefinitionPath)){\n    throw new Error(\"Protocol definition file does not exist.\");\n  }\n  var content = fs.readFileSync(protocolDefinitionPath, \"utf8\");\n  var parsedJSON;\n  try{\n    parsedJSON = JSON.parse(content);\n  }catch(err){\n    throw new Error(\"Protocol definition file is not a valid JSON: \" + err);\n  }\n  var protocols = ProtocolParser.parse(parsedJSON);\n  Globals.set(protocols);\n\n  var ws = require(\"ws\");\n  if (isServer){\n    var server = new Server(ws);\n    server.init(serverListenPort);\n    Globals.setServer(server);\n    Globals.setReady();\n  }else{\n    throw new Error(\"NodeJS clients are not yet supported.\");\n  }\n}\n\nexport default new Rhubarb();\n"],"names":["ReusableBufferCache","cache","Object","prototype","destroy","notify","len","float32","Float32Array","uint8","Uint8Array","buffer","get","strLength","elem","Error","supportedChars","charByteMap","byteCharMap","i","length","Protocol","name","id","parameters","parameterIDsByParameterName","parameterBufferIndicesByParameterName","parameterValues","boundGetter","getter","bind","MAX_STRING_PARAMETER_LENGTH","typeNumerical","isNumerical","requiredBufferLen","parameterName","onValuesReceived","clientID","onReceived","onOwnershipReceived","transferableMessageBody","transferableList","hasOwnership","getCharByte","char","getParameterFromBuffer","parameter","startIndex","value","computationBuffers","setParameterToBuffer","parameterID","maxLength","curIndex","addNumericalParameter","addStringParameter","Math","ceil","init","curParameterID","ProtocolParser","NUMERICAL_TYPE","CHARACTER_TYPE","currentProtocolID","parseCharacterType","characterType","splitted","split","parseInt","parseProtocol","protocolInfo","protocolName","protocolID","protocol","parameterType","startsWith","parse","jsonData","parsedProtocols","Globals","isReady","protocolsByProtocolName","protocolsByProtocolID","server","setReady","onReady","set","protocols","setServer","WorkerBridge","isWorkerInitialized","reusableArray","worker","terminate","onLatencyUpdated","latency","latencyCallback","sendProtocol","error","postMessage","initialize","workerPath","serverURL","Worker","onmessage","event","data","isError","onError","isConnected","isDisconnected","onDisconnectedFromServer","Server","wsLib","wsByClientID","clientIDByWS","Map","ws","wsServer","close","sendProtocolToClient","clientWS","send","port","on","uuidv4","onClientConnected","readFloatLE","bufIndex","paramName","delete","onClientDisconnected","replace","c","r","random","v","toString","Rhubarb","IS_NODE","window","_validateParameters","_initNode","protocolDefinitionPath","serverAddress","xhttpRequest","XMLHttpRequest","overrideMimeType","open","onreadystatechange","readyState","status","parsedJSON","JSON","responseText","err","initWorker","_initWorker","valuesByParameterName","undefined","callback","Function","isServer","serverListenPort","fs","require","existsSync","content","readFileSync"],"mappings":"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"}